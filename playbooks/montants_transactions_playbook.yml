- hosts: prod_integ
  roles:
  - setupVars
  tasks:
  - name: copy scripts and configs
    become: yes
    copy:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      force: yes
      group: "{{ application_usergroup }}"
      owner: "{{ application_username }}"
    with_items:
      - { src: '../api_to_kafka/transaction_to_kafka_realtime.py', dest: '{{ application_userhome }}/transaction_to_kafka_realtime.py' }
      - { src: '../api_to_kafka/historique_montants_to_kafka.py', dest: '{{ application_userhome }}/historique_montants_to_kafka.py' }
      - { src: '../kafka_to_elastic/kafka_historique_montants_to_elastic.py', dest: '{{ application_userhome }}/kafka_historique_montants_to_elastic.py' }
      - { src: '../kafka_to_elastic/transactionToESRealtime/target/transactionToESRealtime-1.0.jar', dest: '{{ application_userhome }}/transactionToESRealtime-1.0.jar' }
      - { src: '../pm2_configs/montants_transactions.config.js', dest: '{{ application_userhome }}/montants_transactions.config.js' }
  - name: ensure that pip is already installed
    apt: name=python-pip state=latest
    become: yes
  - name: install necessary python modules
    pip: name={{ item }} extra_args="--no-cache-dir"
    with_items:
      - elasticsearch
      - kafka
      - requests
      - pyspark
      - websocket
      - websocket-client
  - name: run montants_transactions scripts with pm2
    command: chdir="{{ application_userhome }}" pm2 startOrReload montants_transactions.config.js
